#!/bin/sh

# auto packing for iOS
# shell+xcodebuild packing for iOS
# by biostome 2019-5-19

# è¯´æ˜
# æ­¤è„šæœ¬ç›®å‰åªé’ˆå¯¹æœ‰å·¥ä½œç©ºé—´workspaceæ–‡ä»¶çš„æ‰“åŒ…ã€‚
# æ­¤è„šæœ¬éœ€è¦æ‚¨çš„é¡¹ç›®å¯ä»¥æ‰‹åŠ¨æ‰“åŒ…æˆåŠŸä¸€æ¬¡ï¼Œåªæœ‰xcodeæ‰‹åŠ¨æ‰“åŒ…æˆåŠŸè¿‡ä¸€æ¬¡ï¼Œè‡ªåŠ¨æ‰“åŒ…ä¼šçœå»å¾ˆå¤šé…ç½®å†…å®¹ã€‚
# æ­¤è„šæœ¬åŠ›æ±‚æœ€ç®€åŒ–é…ç½®ï¼Œæœ€å¥½æ˜¯åªéœ€è¦é…ç½®ä¸€å¤„ï¼Œä½†ç›®å‰è¿˜æ˜¯éœ€è¦é…ç½®ä¸¤å¤„ï¼š
    #1ï¼šåŒ¹é…é¡¹ç›®ç›®å½•
    #2ï¼šè®¾ç½®Plistæ–‡ä»¶
# è¯·å…¨å±€æœç´¢ã€é…ç½®ã€‘é…ç½®å†…å®¹ã€‚

# ã€é…ç½®ã€‘é¡¹ç›®ç›®å½•
__project_path="/Users/XXXXX/Desktop/AutoPacking-iOS/AutoPackingDemo"

#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ç›®å½•åœ°å€ --------------
__auto_packing_path=`pwd`

# ã€æ£€æŸ¥å’Œé…ç½®ã€‘è¯·ä¿®æ”¹Plist/AdHocExportOptionsPlist.plistæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥é€šè¿‡æ‰‹åŠ¨æ‰“åŒ…æ–¹å¼å¯¼å‡ºä¸€æ¬¡å°±ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œå¤åˆ¶å‡ºæ¥ç”¨å°±å¯ä»¥äº†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨æ–°å»ºã€‚
# è¿™é‡Œç”¨çš„æ˜¯adhocæ‰“åŒ…æ–¹å¼ï¼Œéœ€è¦å…¶ä»–çš„æ‰“åŒ…æ–¹å¼è¯·è‡ªå·±ç”Ÿæˆplistæ–‡ä»¶ã€‚
__export_options_plist="${__auto_packing_path}/Plist/AdHocExportOptionsPlist.plist"

# ipaåŒ…åˆ°å¤„åœ°å€ï¼Œå¯¼å‡ºä½ç½®æ˜¯è„šæœ¬ä¸‹çš„ipasç›®å½•ï¼Œæ²¡æœ‰ipasç›®å½•ä¼šè‡ªåŠ¨ç”Ÿæˆ
__exportPath="${__auto_packing_path}/ipas"

# å½’æ¡£archiveåœ°å€ï¼Œæ²¡æœ‰åˆ™è‡ªåŠ¨ç”Ÿæˆ
__build_path="${__auto_packing_path}/Build/"


#â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”æ—§æ–‡ä»¶åˆ é™¤â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
echo "<-----------------ğŸš€æ—§æ–‡ä»¶åˆ é™¤ğŸš€------------------->"
if [ -d "${__build_path}" ] ; then
    echo "å‘ç°Buildæ–‡ä»¶å¤¹æœ‰æ–‡ä»¶ï¼Œå³å°†æ¸…ç©ºæ–‡ä»¶å¤¹ğŸ“"
    rm -rf ${__build_path}/*
fi

if [ -d "${__exportPath}" ] ; then
    echo "å‘ç°ipasæ–‡ä»¶å¤¹æœ‰æ–‡ä»¶ï¼Œå³å°†æ¸…ç©ºæ–‡ä»¶å¤¹ğŸ“"
    rm -rf ${__exportPath}/*
fi


#-------------- æ‰“åŒ…å‰å‡†å¤‡ -----------------
echo "<-----------------ğŸš€æ‰“åŒ…å‰å‡†å¤‡ğŸš€------------------->"
# cd åˆ° projectPath è¿™ä¸ªè·¯å¾„
cd ${__project_path}

# è·å–Projectåç§°
__project_name=`ls $__project_path | grep .xcodeproj | sed 's/.xcodeproj//g'`
#__project_name=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`

# è·å–workspaceåç§°
__work_space_name="${__project_name}"

# æ‰‹åŠ¨è®¾ç½®Targets
#__targets=("A scheme" "B scheme" "C scheme")

# è‡ªåŠ¨è®¾ç½®Targets

# æ–¹å¼ä¸€
__targets=`xcodebuild -list -project ${__project_name}.xcodeproj -json | awk '/\"schemes/,/],/' | sed s/[[:space:]]//g | sed -e '1d' -e '$d' -e 's/,//g' -e 's/\"//g'`

# æ–¹å¼äºŒ
#__targets=`xcodebuild -list -project ${__project_name}.xcodeproj -json | grep - | sed s/,//g | sed s/\"//g | sed s/[[:space:]]//g`

# æ–¹å¼å››
#__targets=`xcodebuild -list -workspace ${__work_space_name}.xcworkspace | grep [-] | grep -v Pods | sed s/[[:space:]]//g | awk '{{printf"%s ",$0}}'`


#-------------- æ£€æŸ¥æ•°æ®,æ£€æŸ¥è¿™é‡Œå¾…å®Œå–„ -----------------
echo "<-----------------ğŸš€æ£€æŸ¥æ•°æ®ğŸš€------------------->"
echo "æ–¹æ¡ˆï¼š${__targets}"


#-------------- å¼€å§‹æ‰“åŒ…è¿‡ç¨‹ -----------------
echo "<-----------------ğŸš€å¼€å§‹æ‰“åŒ…ğŸš€------------------->"

#cleanæ‰€æœ‰targeté¡¹ç›®
xcodebuild clean -configuration Release -alltargets
for scheme in ${__targets[@]}; do
    # ç¼–è¯‘ ".xcarchive" æ–‡ä»¶çš„å­˜æ”¾åœ°å€
    __archivePath="${__build_path}/${scheme}"
    echo "<-----------------ğŸš€å¼€å§‹å½’æ¡£archiveæ–‡ä»¶ğŸš€------------------->"
    # å½’æ¡£ å¯¹åº”æ‰‹åŠ¨æ‰“åŒ…archiveï¼ˆä½¿ç”¨workspaceï¼‰
    xcodebuild archive -workspace ${__work_space_name}.xcworkspace -scheme ${scheme} -configuration Release -archivePath ${__archivePath}.xcarchive
    # æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
    # xcarchive å®é™…æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶æ‰€ä»¥ä½¿ç”¨ -d åˆ¤æ–­
    if [ -d "${__archivePath}.xcarchive" ] ; then
        echo "é¡¹ç›®æ„å»ºæˆåŠŸ ğŸ‰ ğŸ‰ ğŸ‰"
    else
        echo "é¡¹ç›®æ„å»ºå¤±è´¥ ğŸ˜¢ ğŸ˜¢ ğŸ˜¢"
        exit 1
    fi
    # ç”Ÿæˆæ‰“åŒ…æ—¶é—´
    __time=$(date "+_%Y-%m-%d_%H-%M-%S")
    __ipaName="${scheme}${__time}"
    # æ‹¼æ¥å¯¼å‡ºipaçš„åœ°å€
    __ipaPath="${__exportPath}/${__ipaName}"
    echo "<-----------------ğŸš€å¼€å§‹å¯¼å‡ºipaæ–‡ä»¶ğŸš€------------------->"
    # å¯¹åº”å¯¼å‡ºæ­¥éª¤
    xcodebuild -exportArchive -archivePath ${__archivePath}.xcarchive -exportPath ${__ipaPath} -exportOptionsPlist ${__export_options_plist}

    if [ -d "${__ipaPath}" ] ; then
        echo "å¯¼å‡º ${__ipaName}.ipa åŒ…æˆåŠŸ ğŸ‰ ğŸ‰ ğŸ‰"
    else
        echo "å¯¼å‡º ${__ipaName}.ipa åŒ…å¤±è´¥ ğŸ˜¢ ğŸ˜¢ ğŸ˜¢"
    fi
done

echo "<-----------------ç»“æŸ------------------->"
echo "æ‰“åŒ…æ€»è€—æ—¶: ${SECONDS}s"
